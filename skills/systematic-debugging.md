# 系統性除錯技能（Systematic Debugging）

> **技能 ID**: `systematic-debugging`
> **版本**: 1.0.0
> **用途**: 四階段根因分析、科學化除錯方法、高效問題定位
> **參考**: [obra/superpowers](https://github.com/obra/superpowers)

---

## 觸發條件

當使用者需求包含以下關鍵字時，應激活此技能：

- 「除錯」、「Debug」、「Debugging」
- 「錯誤」、「Error」、「Bug」
- 「問題排查」、「根因分析」
- 「修復」、「Fix」
- 「為什麼不工作」、「怎麼壞了」

---

## 一、核心原則：鐵律

```
╔════════════════════════════════════════════════════════════╗
║   🚫 NO FIXES WITHOUT ROOT CAUSE INVESTIGATION FIRST 🚫   ║
║                                                            ║
║   沒有根因調查，就沒有修復                                   ║
╚════════════════════════════════════════════════════════════╝
```

**症狀性修復 = 除錯失敗**

快速補丁：
- ❌ 浪費時間
- ❌ 創造新問題
- ❌ 掩蓋真正原因

---

## 二、四階段除錯流程

### 階段 1：根因調查（Root Cause Investigation）

```markdown
📋 調查清單：

1. 仔細閱讀錯誤訊息
   - 完整錯誤堆疊
   - 關鍵行號
   - 錯誤類型

2. 穩定重現問題
   - 確定重現步驟
   - 記錄觸發條件
   - 驗證是否一致

3. 檢查最近變更
   - git diff
   - 最近的 commit
   - 配置變更

4. 收集診斷證據
   - 日誌輸出
   - 網路請求
   - 資料庫狀態

5. 追蹤資料流
   - 從錯誤點向後追溯
   - 檢查每個調用層
   - 識別資料轉換點
```

### 階段 2：模式分析（Pattern Analysis）

```markdown
📋 分析清單：

1. 找到正常工作的範例
   - 類似功能
   - 歷史版本
   - 參考實現

2. 完整比較實現
   - 逐行對比
   - 配置差異
   - 依賴版本

3. 識別所有差異
   - 代碼差異
   - 環境差異
   - 時序差異

4. 理解依賴關係
   - 外部服務
   - 共享狀態
   - 執行順序
```

### 階段 3：假設與測試（Hypothesis Testing）

```markdown
📋 科學方法：

1. 形成具體假設
   - "我認為問題是 X，因為 Y"
   - 可驗證的預測
   - 一次一個假設

2. 最小化測試
   - 單一變更
   - 隔離測試
   - 記錄結果

3. 驗證結果
   - 符合預期 → 進入階段 4
   - 不符合 → 形成新假設

4. 三次失敗規則
   ⚠️ 如果三次或更多修復失敗，
   停下來質疑架構，而不是繼續嘗試
```

### 階段 4：實施修復（Implementation）

```markdown
📋 修復清單：

1. 先寫失敗測試
   - 重現 bug 的測試
   - 確認測試失敗

2. 實施單一修復
   - 針對根因
   - 最小變更
   - 清晰意圖

3. 驗證修復
   - 測試通過
   - 原問題解決
   - 無新問題引入

4. 提交變更
   git commit -m "fix: [問題描述] - 根因: [根因說明]"
```

---

## 三、紅旗警告

當你發現自己做以下事情時，**立即停下**：

```markdown
🚩 紅旗 1：在追蹤資料流之前就提出解決方案
   → 回到階段 1

🚩 紅旗 2：嘗試「只是一個快速修復」
   → 這正是問題所在

🚩 紅旗 3：同時進行多個變更
   → 一次只改一個

🚩 紅旗 4：說「這應該可以工作」但沒有驗證
   → 執行驗證命令

🚩 紅旗 5：第三次修復嘗試失敗
   → 質疑架構，不是繼續猜測
```

---

## 四、除錯工具箱

### 4.1 日誌除錯

```typescript
// ✅ 好：結構化日誌
console.log('[DEBUG] fetchUser', {
  userId,
  timestamp: Date.now(),
  requestId: ctx.requestId
});

// ❌ 壞：無上下文日誌
console.log('here');
console.log(data);
```

### 4.2 二分法定位

```bash
# 使用 git bisect 定位引入問題的 commit
git bisect start
git bisect bad HEAD
git bisect good v1.0.0

# 重複測試直到找到問題 commit
# 測試通過: git bisect good
# 測試失敗: git bisect bad
```

### 4.3 最小重現案例

```typescript
// 創建最小重現案例
// 1. 移除所有無關代碼
// 2. 硬編碼必要數據
// 3. 隔離問題組件

// 最小重現案例
function minimalReproduction() {
  const input = { /* 觸發問題的最小輸入 */ };
  const result = problematicFunction(input);
  console.log('Result:', result);
  // 預期: X, 實際: Y
}
```

---

## 五、常見除錯模式

### 5.1 「它昨天還能用」

```markdown
調查步驟：
1. git log --oneline -20
2. 找到最後正常的 commit
3. git diff <good-commit>..HEAD
4. 審查每個變更
```

### 5.2 「只在生產環境出錯」

```markdown
調查步驟：
1. 比較環境差異
   - 環境變數
   - 依賴版本
   - 資料庫資料
2. 複製生產配置到本地
3. 使用生產資料（脫敏）測試
```

### 5.3 「有時候會出錯」（間歇性問題）

```markdown
調查步驟：
1. 識別模式
   - 時間相關？
   - 負載相關？
   - 資料相關？
2. 增加日誌覆蓋
3. 收集多次失敗的共同點
4. 檢查競態條件
```

### 5.4 「沒有錯誤訊息」

```markdown
調查步驟：
1. 確認錯誤處理正確
2. 檢查 try-catch 是否吞掉錯誤
3. 檢查 Promise 是否有 catch
4. 檢查日誌級別配置
```

---

## 六、效能指標

```markdown
使用此方法：
- 除錯時間：2-3 小時 → 15-30 分鐘
- 首次修復成功率：40% → 95%
- 新問題引入率：30% → <5%
```

---

## 七、禁止行為

```markdown
❌ 絕對禁止：
1. 在理解問題之前就開始修改代碼
2. 同時進行多個變更
3. 說「試試這個」而不說「因為 X，我預期 Y」
4. 跳過驗證步驟
5. 忽略錯誤訊息的細節
6. 假設問題在某處而不驗證
7. 持續猜測超過三次
8. 在不理解的情況下複製 StackOverflow 答案
```

---

## 八、自檢清單

```markdown
□ 我完整閱讀了錯誤訊息
□ 我能穩定重現問題
□ 我追蹤了資料流
□ 我找到了正常工作的參考
□ 我形成了可驗證的假設
□ 我一次只改一個東西
□ 我驗證了修復確實有效
□ 我沒有引入新問題
□ 我寫了防止回歸的測試
```

---

## 參考資源

- [obra/superpowers - systematic-debugging](https://github.com/obra/superpowers)
- [The Art of Debugging](https://www.debuggingrules.com/)

---

**版本**: 1.0.0
**最後更新**: 2025-12-26
